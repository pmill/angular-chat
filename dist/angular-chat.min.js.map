{"version":3,"sources":["module.js","directives/lobby.js","services/chatroom.js","services/socket.js","templates.js"],"names":["angular","module","Directive","restrict","scope","user","templateUrl","replace","controller","Controller","controllerAs","bindToController","$scope","ChatRoomService","activate","lobby","fetchRoom","vm","data","lobbyName","connect","then","sendUserConnected","onUserConnected","userDetailsReceived","onUserDisconnected","userDisconnected","onUserDetailsReceived","onRoomCreated","roomCreated","chatWithUser","selectedRoom","disconnect","room","startChatWithUser","userDetails","users","id","state","loading","$apply","roomName","rooms","push","this","directive","$inject","Service","$window","SocketService","Chatroom","onbeforeunload","send","currentUser","subscribe","sendMessage","message","sendUserDetails","callback","on","onMessageReceived","onUserConnectedCallback","instigator","createRoomChannelName","userIds","sort","hashCode","join","s","split","reduce","a","b","charCodeAt","prototype","factory","$q","socketConfig","client","ScaleDrone","channelId","resolve","reject","error","close","onDisconnect","console","log","eventName","event","payload","publish","run","$templateCache","put"],"mappings":"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","file":"angular-chat.min.js","sourcesContent":["(function() {\n  \"use strict\";\n\n  angular\n    .module('angular-chat', []);\n})();","(function() {\n  \"use strict\";\n\n  angular\n    .module('angular-chat')\n    .directive('pmChatLobby', Directive);\n\n  function Directive() {\n    return {\n      restrict: 'E',\n      scope: {\n        user: '='\n      },\n      templateUrl: 'lobby.html',\n      replace: true,\n      controller: Controller,\n      controllerAs: 'vm',\n      bindToController: true\n    };\n  }\n\n  Controller.$inject = ['$scope', 'ChatRoomService'];\n\n  function Controller($scope, ChatRoomService) {\n    var vm = this;\n\n    vm.data = {\n      lobbyName: 'public-chat-users',\n      users: {},\n      user: vm.user,\n      selectedRoom: null\n    };\n\n    vm.state = {\n      loading: true\n    };\n\n    vm.chatWithUser = chatWithUser;\n\n    activate();\n\n    function activate() {\n      var lobby = ChatRoomService.fetchRoom(vm.data.lobbyName, vm.user);\n      lobby.connect(vm.data.lobbyName, vm.user).then(function() {\n        lobby.sendUserConnected();\n        lobby.onUserConnected(userDetailsReceived);\n        lobby.onUserDisconnected(userDisconnected);\n        lobby.onUserDetailsReceived(userDetailsReceived);\n        lobby.onRoomCreated(roomCreated);\n      });\n    }\n\n    function chatWithUser(user) {\n      if (vm.data.selectedRoom !== null) {\n        vm.data.selectedRoom.disconnect();\n      }\n\n      if (user.room === null) {\n        vm.data.selectedRoom = user.room;\n      } else {\n        vm.data.selectedRoom = user.room = ChatRoomService.startChatWithUser(vm.user, user)\n      }\n    }\n\n    function userDisconnected(userDetails) {\n      delete vm.data.users[userDetails.id];\n    }\n\n    function userDetailsReceived(userDetails) {\n      if (userDetails.id !== vm.data.user.id) {\n        vm.data.users[userDetails.id] = userDetails;\n        vm.state.loading = false;\n        $scope.$apply();\n      }\n    }\n\n    function roomCreated(roomName) {\n      vm.data.rooms.push(roomName);\n      $scope.$apply();\n    }\n  }\n})();","(function() {\n  \"use strict\";\n\n  angular\n    .module('angular-chat')\n    .factory('ChatRoomService', Service);\n\n  Service.$inject = ['$window', 'SocketService'];\n\n  function Service($window, SocketService) {\n    var Chatroom = function(roomName, userDetails) {\n      this.roomName = roomName;\n      this.currentUser = userDetails;\n    };\n\n    Chatroom.prototype.connect = connect;\n    Chatroom.prototype.disconnect = disconnect;\n    Chatroom.prototype.onRoomCreated = onRoomCreated;\n    Chatroom.prototype.onMessageReceived = onMessageReceived;\n    Chatroom.prototype.onUserDetailsReceived = onUserDetailsReceived;\n    Chatroom.prototype.onUserConnected = onUserConnected;\n    Chatroom.prototype.onUserDisconnected = onUserDisconnected;\n    Chatroom.prototype.sendMessage = sendMessage;\n    Chatroom.prototype.sendUserConnected = sendUserConnected;\n    Chatroom.prototype.sendUserDetails = sendUserDetails;\n    Chatroom.prototype.startChatWithUser = startChatWithUser;\n\n    return {\n      fetchRoom: fetchRoom,\n      startChatWithUser: startChatWithUser\n    };\n\n    function fetchRoom(roomName, userDetails) {\n      return new Chatroom(roomName, userDetails);\n    }\n\n    function connect() {\n      var room = this;\n\n      $window.onbeforeunload = function () {\n        SocketService.send(this.roomName, 'user.disconnected', this.currentUser);\n      };\n\n      return SocketService.connect().then(function() {\n        return SocketService.subscribe(room.roomName);\n      });\n    }\n\n    function disconnect() {\n      SocketService.disconnect(this.roomName, this.currentUser);\n    }\n\n    function sendMessage(message) {\n      return SocketService.send(this.roomName, 'message.received', message);\n    }\n\n    function sendUserConnected() {\n      return SocketService.send(this.roomName, 'user.connected', this.currentUser);\n    }\n\n    function sendUserDetails() {\n      return SocketService.send(this.roomName, 'user.details', this.currentUser);\n    }\n\n    function onRoomCreated(callback) {\n      return SocketService.on(this.roomName, 'room.created', this.callback);\n    }\n\n    function onMessageReceived(callback) {\n      return SocketService.on(this.roomName, 'message.received', this.callback);\n    }\n\n    function onUserConnected(callback) {\n      var room = this;\n      return SocketService.on(this.roomName, 'user.connected', onUserConnectedCallback);\n\n      function onUserConnectedCallback(userDetails) {\n        room.sendUserDetails(room.currentUser);\n        callback(userDetails)\n      }\n    }\n\n    function onUserDisconnected(callback) {\n      return SocketService.on(this.roomName, 'user.disconnected', callback);\n    }\n\n    function onUserDetailsReceived(callback) {\n      return SocketService.on(this.roomName, 'user.details', callback);\n    }\n\n    function startChatWithUser(instigator, user) {\n      if (user.id === instigator.id) {\n        throw \"Can't start a chat with yourself!\";\n      }\n\n      var roomName = createRoomChannelName([instigator.id, user.id]);\n      fetchRoom(roomName, instigator).then(function() {\n        return SocketService.send(roomName, 'room.created', roomName);\n      });\n    }\n\n    function createRoomChannelName(userIds) {\n      userIds = userIds.sort();\n      return 'private-chat-room-' + hashCode(userIds.join('|'));\n    }\n\n    function hashCode(s){\n      return s.split(\"\").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);\n    }\n  }\n})();","(function() {\n  \"use strict\";\n\n  angular\n    .module('angular-chat')\n    .factory('SocketService', Service);\n\n  Service.$inject = ['$q', 'socketConfig'];\n\n  function Service($q, socketConfig) {\n    var client;\n    var rooms = {};\n\n    return {\n      connect: connect,\n      disconnect: disconnect,\n      on: on,\n      onDisconnect: onDisconnect,\n      room: room,\n      send: send,\n      subscribe: subscribe\n    };\n\n    function connect() {\n      client = new ScaleDrone(socketConfig.channelId);\n\n      return $q(function(resolve, reject) {\n        client.on('open', function (error) {\n          if (error) {\n            return reject(error);\n          }\n\n          return resolve();\n        });\n      });\n    }\n\n    function disconnect(roomName, user) {\n      send(roomName, 'user.disconnected', user);\n      client.close();\n    }\n\n    function onDisconnect() {\n      return $q(function(resolve, reject) {\n        client.on('close', function () {\n          console.log('close()');\n          resolve();\n        });\n      });\n    }\n\n    function on(roomName, eventName, callback) {\n      console.log('subscribing to event', roomName, eventName);\n      room(roomName).on('data', function (data) {\n        if (data.event == eventName) {\n          console.log('processing message', roomName, eventName, data);\n          callback(data.payload);\n        }\n      });\n    }\n\n    function send(roomName, eventName, payload) {\n      console.log('sending message', roomName, eventName, payload);\n      client.publish({\n        room: roomName,\n        message: {\n          event: eventName,\n          payload: payload\n        }\n      });\n    }\n\n    function subscribe(roomName) {\n      return $q(function(resolve, reject) {\n        rooms[roomName] = client.subscribe(roomName);\n\n        rooms[roomName].on('open', function (error) {\n          if (error) {\n            return reject(error);\n          }\n\n          return resolve();\n        });\n      });\n    }\n\n    function room(roomName) {\n      return rooms[roomName];\n    }\n  }\n})();","(function(){angular.module(\"angular-chat\").run([\"$templateCache\", function($templateCache) {$templateCache.put(\"lobby.html\",\"<div class=\\\"row\\\">\\n    <div class=\\\"col-md-4 col-xs-12\\\">\\n        <div class=\\\"panel panel-default\\\">\\n            <div class=\\\"panel-heading\\\">\\n                <h3 class=\\\"panel-title\\\"><span class=\\\"fa fa-users\\\"></span> Lobby</h3>\\n            </div>\\n\\n            <div class=\\\"list-group\\\">\\n                <button class=\\\"list-group-item\\\"\\n                        ng-repeat=\\\"u in vm.data.users\\\"\\n                        ng-if=\\\"!vm.state.loading\\\"\\n                        ng-click=\\\"vm.chatWithUser(u)\\\">\\n                    <h4 class=\\\"list-group-item-heading\\\">\\n                        <span class=\\\"fa fa-user\\\"></span> {{u.name}}\\n                    </h4>\\n                </button>\\n                <span class=\\\"list-group-item\\\" ng-if=\\\"vm.state.loading\\\">\\n                    <h4 class=\\\"list-group-item-heading\\\">\\n                        <i class=\\\"fa fa-cog fa-spin fa-fw margin-bottom\\\"></i>\\n                        loading...\\n                    </h4>\\n                </span>\\n            </div>\\n        </div>\\n    </div>\\n\\n    <div class=\\\"col-md-8\\\">\\n        <div class=\\\"panel panel-default\\\" ng-if=\\\"vm.data.selectedRoom !== null\\\">\\n            <div class=\\\"panel-heading\\\">\\n                <h3 class=\\\"panel-title\\\"><span class=\\\"fa fa-comment-o\\\"></span> Room</h3>\\n            </div>\\n        </div>\\n    </div>\\n</div>\\n\");}]);})();"],"sourceRoot":"/source/"}